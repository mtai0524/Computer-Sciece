@page
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    // Layout = "_Layout";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";

}
<component type="typeof(App)" render-mode="ServerPrerendered" />

<script>
    function showText() {
        return alert("hello");
    }
</script>
<script>
    function clearInputFileText(inputId) {
        var input = document.getElementById(inputId);
        if (input) {
            input.value = '';
        }
    }
    function showModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.style.display = 'block';
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.style.display = 'none';
    }

    document.addEventListener('click', function (event) {
        if (event.target.classList.contains('close')) {
            closeModal(event.target.closest('.modal').id);
        }
    });

    function drapAndDrop() {
        var columns = document.querySelectorAll('.project-column');
        columns.forEach(function (column) {
            new Sortable(column, {
                group: 'tasks',
                animation: 150,
                ghostClass: 'task-placeholder',
                filter: '.project-column-heading__title',
                onEnd: async function (evt) {
                    var tasks = evt.to.querySelectorAll('.task');
                    var numTasks = tasks.length;

                    // Xác định project mới mà task được kéo thả đến
                    var newProjectId = evt.to.closest('.project-column').getAttribute('data-project-id');
                    console.log("newProjectId: " + newProjectId);

                    // Tính toán vị trí mới của mỗi phần tử dựa trên sự kiện kéo thả
                    for (var i = 0; i < numTasks; i++) {
                        var task = tasks[i];
                        var taskId = task.getAttribute('data-task-id');
                        var newPosition = Array.from(task.parentNode.children).indexOf(task);
                        // Cập nhật vị trí của tác vụ
                        await updateTaskPosition(taskId, newPosition, newProjectId);
                    }
                }
            });
        });
    }

    async function updateTaskPosition(taskId, position, projectId) {
        try {
            const response = await fetch(`/api/tasks/${taskId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ position: position, projectId: projectId })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            console.log('Vị trí tác vụ đã được cập nhật thành công');
        } catch (error) {
            console.error('Lỗi khi cập nhật vị trí tác vụ:', error);
        }
    }



    function initProjectTasks() {
        // Tạo một Sortable instance cho mỗi cột
        var columns = document.querySelectorAll('.project-column');
        columns.forEach(function (column) {
            new Sortable(column, {
                group: 'tasks', // Group cho phép kéo thả giữa các cột
                animation: 150, // Thời gian animation khi di chuyển
                ghostClass: 'task-placeholder', // Class của phần tử placeholder khi kéo thả
                filter: '.project-column-heading__title',
                onEnd: async function (evt) {
                    var tasks = evt.to.querySelectorAll('.task');
                    var numTasks = tasks.length;

                    // Xác định project mới mà task được kéo thả đến
                    var newProjectId = evt.to.closest('.project-column').getAttribute('data-project-id');

                    console.log("newProjectId: " + newProjectId);

                    // Tính toán vị trí mới của mỗi phần tử dựa trên sự kiện kéo thả
                    for (var i = 0; i < numTasks; i++) {
                        var task = tasks[i];
                        var taskId = task.getAttribute('data-task-id');
                        var newPosition = Array.from(task.parentNode.children).indexOf(task);

                        // Cập nhật vị trí của tác vụ
                        await updateTaskPosition(taskId, newPosition, newProjectId);
                    }
                }
            });
        });
    }


</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
<script src="~/js/site.js"></script>